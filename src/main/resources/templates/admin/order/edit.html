<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/admin}">
  <head>
    <title>Chỉnh sửa đơn hàng #<span th:text="${order.id}"></span></title>
  </head>
  <body>
    <div layout:fragment="content">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-pencil-square text-primary me-2"></i>Chỉnh sửa đơn
            hàng #<span th:text="${order.id}"></span>
          </h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item">
                <a th:href="@{/admin}">Dashboard</a>
              </li>
              <li class="breadcrumb-item">
                <a th:href="@{/admin/orders}">Đơn hàng</a>
              </li>
              <li class="breadcrumb-item active">Chỉnh sửa</li>
            </ol>
          </nav>
        </div>
        <div>
          <a
            th:href="@{/admin/orders/{id}(id=${order.id})}"
            class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Quay lại
          </a>
        </div>
      </div>

      <!-- Flash Messages -->
      <div
        th:if="${success}"
        class="alert alert-success alert-dismissible fade show"
        role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"></button>
      </div>

      <div
        th:if="${error}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:text="${error}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"></button>
      </div>

      <form
        th:action="@{/admin/orders/edit/{id}(id=${order.id})}"
        method="post"
        class="needs-validation"
        novalidate>
        <div class="row g-4">
          <!-- Left Column -->
          <div class="col-lg-8">
            <!-- Order Info Card -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-semibold">
                  <i class="bi bi-info-circle text-primary me-2"></i>Thông tin
                  đơn hàng
                </h5>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Order Status -->
                  <div class="col-md-6">
                    <label for="orderStatus" class="form-label fw-semibold"
                      >Trạng thái đơn hàng
                      <span class="text-danger">*</span></label
                    >
                    <select
                      class="form-select"
                      id="orderStatus"
                      name="orderStatus"
                      required>
                      <option
                        th:each="status : ${orderStatuses}"
                        th:value="${status.name()}"
                        th:text="${status.displayName}"
                        th:selected="${status == order.orderStatus}"></option>
                    </select>
                  </div>

                  <!-- Payment Status -->
                  <div class="col-md-6" th:if="${order.payment != null}">
                    <label for="paymentStatus" class="form-label fw-semibold"
                      >Trạng thái thanh toán</label
                    >
                    <select
                      class="form-select"
                      id="paymentStatus"
                      name="paymentStatus">
                      <option
                        th:each="status : ${paymentStatuses}"
                        th:value="${status.name()}"
                        th:text="${status.name()}"
                        th:selected="${status == order.payment.status}"></option>
                    </select>
                  </div>

                  <!-- Order Info Display -->
                  <div class="col-12">
                    <hr class="my-3" />
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="text-muted small fw-semibold"
                          >Phương thức thanh toán</label
                        >
                        <p
                          class="mb-0"
                          th:text="${order.paymentMethod.name()}"></p>
                      </div>
                      <div class="col-md-6">
                        <label class="text-muted small fw-semibold"
                          >Ngày đặt</label
                        >
                        <p
                          class="mb-0"
                          th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Shipping Address Card -->
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-semibold">
                  <i class="bi bi-geo-alt text-primary me-2"></i>Địa chỉ giao
                  hàng
                </h5>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="recipientName" class="form-label fw-semibold"
                      >Người nhận <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="recipientName"
                      name="recipientName"
                      th:value="${order.orderAddress?.recipientName}"
                      required />
                  </div>

                  <div class="col-md-6">
                    <label for="phone" class="form-label fw-semibold"
                      >Số điện thoại <span class="text-danger">*</span></label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="phone"
                      name="phone"
                      th:value="${order.orderAddress?.phone}"
                      required />
                  </div>

                  <div class="col-12">
                    <label for="addressLine" class="form-label fw-semibold"
                      >Địa chỉ <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="addressLine"
                      name="addressLine"
                      th:value="${order.orderAddress?.addressLine}"
                      required />
                  </div>

                  <div class="col-md-4">
                    <label for="ward" class="form-label fw-semibold"
                      >Phường/Xã <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="ward"
                      name="ward"
                      th:value="${order.orderAddress?.ward}"
                      required />
                  </div>

                  <div class="col-md-4">
                    <label for="district" class="form-label fw-semibold"
                      >Quận/Huyện <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="district"
                      name="district"
                      th:value="${order.orderAddress?.district}"
                      required />
                  </div>

                  <div class="col-md-4">
                    <label for="city" class="form-label fw-semibold"
                      >Tỉnh/Thành phố <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="city"
                      name="city"
                      th:value="${order.orderAddress?.city}"
                      required />
                  </div>

                  <div class="col-12">
                    <label for="note" class="form-label fw-semibold"
                      >Ghi chú</label
                    >
                    <textarea
                      class="form-control"
                      id="note"
                      name="note"
                      rows="3"
                      th:text="${order.orderAddress?.note}"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="col-lg-4">
            <!-- Order Items Summary -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-semibold">
                  <i class="bi bi-box-seam text-primary me-2"></i>Sản phẩm
                </h5>
              </div>
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom"
                  th:each="item : ${order.orderItems}"
                  th:id="'item-' + ${item.id}">
                  <div class="d-flex align-items-center flex-grow-1">
                    <!-- Product Image -->
                    <div class="me-2" style="width: 50px; height: 50px">
                      <img
                        th:if="${item.variant.product.images != null && !item.variant.product.images.isEmpty()}"
                        th:src="${item.variant.product.images[0].urlImage}"
                        th:alt="${item.variant.product.productName}"
                        class="img-fluid rounded"
                        style="width: 50px; height: 50px; object-fit: cover" />
                      <!-- Fallback icon -->
                      <div
                        th:if="${item.variant.product.images == null || item.variant.product.images.isEmpty()}"
                        class="bg-light rounded d-flex align-items-center justify-content-center"
                        style="width: 50px; height: 50px">
                        <i class="bi bi-box-seam text-muted"></i>
                      </div>
                    </div>
                    <!-- Product Info -->
                    <div class="flex-grow-1">
                      <div
                        class="fw-semibold small"
                        th:text="${item.variant.product.productName}"></div>
                      <div class="d-flex align-items-center gap-2 mt-1">
                        <small
                          class="text-muted"
                          th:text="${item.variant.skuVariant}"></small>
                        <span class="text-muted">×</span>
                        <!-- Editable Quantity Input -->
                        <input
                          type="number"
                          min="1"
                          class="form-control form-control-sm quantity-input"
                          style="width: 70px"
                          th:value="${item.quantity}"
                          th:data-order-id="${order.id}"
                          th:data-item-id="${item.id}"
                          th:data-unit-price="${item.unitPrice}" />
                      </div>
                    </div>
                  </div>
                  <div class="text-end">
                    <span
                      class="fw-semibold item-total"
                      th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                  </div>
                </div>

                <div class="mt-3 pt-3 border-top">
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Tạm tính:</span>
                    <span
                      id="subTotalDisplay"
                      th:text="${#numbers.formatDecimal(order.subTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                  </div>
                  <div
                    class="d-flex justify-content-between mb-2"
                    th:if="${order.discountAmount != null && order.discountAmount > 0}">
                    <span class="text-muted">Giảm giá:</span>
                    <span
                      class="text-danger"
                      id="discountDisplay"
                      th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                  </div>
                  <div class="d-flex justify-content-between pt-2 border-top">
                    <span class="fw-bold">Tổng cộng:</span>
                    <span class="fw-bold text-success fs-5" id="totalDisplay">
                      <span
                        th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')}"></span>
                      ₫
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="card border-0 shadow-sm">
              <div class="card-body d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-check-circle me-2"></i>Lưu thay đổi
                </button>
                <a
                  th:href="@{/admin/orders/{id}(id=${order.id})}"
                  class="btn btn-outline-secondary">
                  <i class="bi bi-x-circle me-2"></i>Hủy
                </a>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Bootstrap Validation + Quantity Update Script -->
    <script layout:fragment="scripts">
      // Bootstrap form validation
      (function () {
        "use strict";
        var forms = document.querySelectorAll(".needs-validation");
        Array.prototype.slice.call(forms).forEach(function (form) {
          form.addEventListener(
            "submit",
            function (event) {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add("was-validated");
            },
            false
          );
        });
      })();

      // Quantity Update AJAX
      document.querySelectorAll(".quantity-input").forEach((input) => {
        let timeout = null;

        input.addEventListener("change", function () {
          updateQuantity(this);
        });

        // Auto-update when typing (debounced)
        input.addEventListener("input", function () {
          clearTimeout(timeout);
          timeout = setTimeout(() => updateQuantity(this), 800);
        });
      });

      function updateQuantity(input) {
        const orderId = input.dataset.orderId;
        const itemId = input.dataset.itemId;
        const quantity = parseInt(input.value);
        const unitPrice = parseFloat(input.dataset.unitPrice);

        if (quantity < 1) {
          alert("Số lượng phải lớn hơn 0");
          input.value = 1;
          return;
        }

        // Show loading state
        input.disabled = true;
        input.style.opacity = "0.5";

        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector(
          'meta[name="_csrf_header"]'
        )?.content;

        fetch(
          `/admin/orders/${orderId}/items/${itemId}/quantity?quantity=${quantity}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              [csrfHeader]: csrfToken,
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Update item total
              const itemRow = document.getElementById(`item-${itemId}`);
              const itemTotal = itemRow.querySelector(".item-total");
              const newItemTotal = (unitPrice * quantity).toLocaleString(
                "vi-VN"
              );
              itemTotal.textContent = newItemTotal + " ₫";

              // Update order totals
              document.getElementById("subTotalDisplay").textContent =
                formatNumber(data.subTotal) + " ₫";

              if (data.discountAmount && data.discountAmount > 0) {
                document.getElementById("discountDisplay").textContent =
                  "-" + formatNumber(data.discountAmount) + " ₫";
              }

              document.getElementById(
                "totalDisplay"
              ).innerHTML = `<span>${formatNumber(data.totalAmount)}</span> ₫`;

              // Show success toast
              showToast("Cập nhật thành công!", "success");
            } else {
              alert("Lỗi: " + data.message);
              location.reload();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Có lỗi xảy ra, vui lòng thử lại!");
            location.reload();
          })
          .finally(() => {
            input.disabled = false;
            input.style.opacity = "1";
          });
      }

      function formatNumber(num) {
        return new Intl.NumberFormat("vi-VN").format(num);
      }

      function showToast(message, type = "success") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = "9999";
        alertDiv.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
