<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/admin}">
  <head>
    <title>Dashboard - Admin</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div layout:fragment="content">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 fw-bold text-dark mb-1">
            <i class="bi bi-speedometer2 text-primary me-2"></i>Dashboard
          </h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item active">Tổng quan</li>
            </ol>
          </nav>
        </div>
      </div>

      <!-- Stats Widgets - 4 Main Cards -->
      <div class="row g-4 mb-4">
        <!-- Doanh thu hôm nay -->
        <div class="col-xl-3 col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div
                  class="flex-shrink-0 bg-success bg-opacity-10 rounded-3 p-3 me-3">
                  <i class="bi bi-currency-dollar text-success fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1 small">Doanh thu hôm nay</h6>
                  <h3
                    class="mb-0 fw-bold"
                    th:text="${#numbers.formatDecimal(todayRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                    0 đ
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Doanh thu tháng này -->
        <div class="col-xl-3 col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div
                  class="flex-shrink-0 bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                  <i class="bi bi-calendar-check text-primary fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1 small">Doanh thu tháng này</h6>
                  <h3
                    class="mb-0 fw-bold"
                    th:text="${#numbers.formatDecimal(thisMonthRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                    0 đ
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tăng trưởng so tháng trước -->
        <div class="col-xl-3 col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div
                  class="flex-shrink-0 rounded-3 p-3 me-3"
                  th:classappend="${growthPercentage >= 0 ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'}">
                  <i
                    class="fs-4"
                    th:classappend="${growthPercentage >= 0 ? 'bi bi-graph-up-arrow text-success' : 'bi bi-graph-down-arrow text-danger'}"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1 small">So với tháng trước</h6>
                  <h3
                    class="mb-0 fw-bold"
                    th:classappend="${growthPercentage >= 0 ? 'text-success' : 'text-danger'}">
                    <span th:if="${growthPercentage >= 0}">+</span
                    ><span
                      th:text="${#numbers.formatDecimal(growthPercentage, 1, 'POINT', 1, 'POINT')}"
                      >0</span
                    >%
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Giá trị đơn trung bình -->
        <div class="col-xl-3 col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div
                  class="flex-shrink-0 bg-info bg-opacity-10 rounded-3 p-3 me-3">
                  <i class="bi bi-cart-check text-info fs-4"></i>
                </div>
                <div>
                  <h6 class="text-muted mb-1 small">Đơn trung bình</h6>
                  <h3
                    class="mb-0 fw-bold"
                    th:text="${#numbers.formatDecimal(avgOrderValue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                    0 đ
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenue Charts Row -->
      <div class="row g-4 mb-4">
        <!-- Revenue Trends Chart (Large) -->
        <div class="col-lg-8">
          <div class="card h-100">
            <div
              class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Biểu đồ doanh thu</h5>
              <div class="btn-group btn-group-sm" role="group">
                <input
                  type="radio"
                  class="btn-check"
                  name="revenuePeriod"
                  id="revenue7d"
                  autocomplete="off"
                  checked />
                <label class="btn btn-outline-secondary" for="revenue7d"
                  >7D</label
                >
                <input
                  type="radio"
                  class="btn-check"
                  name="revenuePeriod"
                  id="revenue30d"
                  autocomplete="off" />
                <label class="btn btn-outline-secondary" for="revenue30d"
                  >30D</label
                >
              </div>
            </div>
            <div class="card-body p-3 p-lg-4">
              <div style="position: relative; height: 300px; width: 100%">
                <canvas id="revenueTrendsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Product by Category (Donut) -->
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="card-title mb-0">Sản phẩm theo danh mục</h5>
            </div>
            <div class="card-body p-3 p-lg-4">
              <div style="position: relative; height: 300px; width: 100%">
                <canvas id="categoryDonutChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row">
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0 fw-semibold">
                <i class="bi bi-lightning text-warning me-2"></i>Thao tác nhanh
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6 col-md-3">
                  <a
                    th:href="@{/admin/products/create}"
                    class="btn btn-outline-primary w-100 py-3">
                    <i class="bi bi-plus-circle d-block fs-4 mb-1"></i>
                    Thêm sản phẩm
                  </a>
                </div>
                <div class="col-6 col-md-3">
                  <a
                    th:href="@{/admin/orders}"
                    class="btn btn-outline-warning w-100 py-3">
                    <i class="bi bi-bag-check d-block fs-4 mb-1"></i>
                    Xử lý đơn hàng
                  </a>
                </div>
                <div class="col-6 col-md-3">
                  <a
                    th:href="@{/admin/users}"
                    class="btn btn-outline-info w-100 py-3">
                    <i class="bi bi-people d-block fs-4 mb-1"></i>
                    Quản lý KH
                  </a>
                </div>
                <div class="col-6 col-md-3">
                  <a
                    th:href="@{/admin/reports}"
                    class="btn btn-outline-success w-100 py-3">
                    <i class="bi bi-graph-up d-block fs-4 mb-1"></i>
                    Xem báo cáo
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart.js Scripts -->
      <script th:inline="javascript">
        // Chart Data from Server
        const weeklyLabels = /*[[${weeklyChartLabels}]]*/ [];
        const weeklyData = /*[[${weeklyChartData}]]*/ [];
        const monthlyLabels = /*[[${monthlyChartLabels}]]*/ [];
        const monthlyData = /*[[${monthlyChartData}]]*/ [];

        // Format number to VND
        function formatVND(value) {
          return new Intl.NumberFormat("vi-VN").format(value) + " đ";
        }

        // Revenue Trends Chart (Line)
        let revenueTrendsChart;
        const trendsCtx = document
          .getElementById("revenueTrendsChart")
          .getContext("2d");

        function createTrendsChart(labels, data) {
          if (revenueTrendsChart) {
            revenueTrendsChart.destroy();
          }
          revenueTrendsChart = new Chart(trendsCtx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Doanh thu",
                  data: data,
                  borderColor: "#198754",
                  backgroundColor: "rgba(25, 135, 84, 0.1)",
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: "#198754",
                  pointBorderColor: "#fff",
                  pointBorderWidth: 2,
                  pointRadius: 4,
                  pointHoverRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return formatVND(context.raw);
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return new Intl.NumberFormat("vi-VN", {
                        notation: "compact",
                      }).format(value);
                    },
                  },
                  grid: { color: "rgba(0,0,0,0.05)" },
                },
                x: {
                  grid: { display: false },
                },
              },
            },
          });
        }

        // Initialize with 7D data
        createTrendsChart(weeklyLabels, weeklyData);

        // Period toggle handlers
        document
          .getElementById("revenue7d")
          .addEventListener("change", function () {
            if (this.checked) createTrendsChart(weeklyLabels, weeklyData);
          });
        document
          .getElementById("revenue30d")
          .addEventListener("change", function () {
            if (this.checked) createTrendsChart(monthlyLabels, monthlyData);
          });

        // Product by Category Chart (Doughnut)
        const categoryLabels = /*[[${categoryLabels}]]*/ [];
        const categoryData = /*[[${categoryData}]]*/ [];

        const categoryColors = [
          "#6366f1",
          "#8b5cf6",
          "#ec4899",
          "#f43f5e",
          "#f97316",
          "#eab308",
          "#22c55e",
          "#14b8a6",
          "#06b6d4",
          "#3b82f6",
        ];

        new Chart(document.getElementById("categoryDonutChart"), {
          type: "doughnut",
          data: {
            labels: categoryLabels,
            datasets: [
              {
                data: categoryData,
                backgroundColor: categoryColors.slice(0, categoryData.length),
                borderWidth: 2,
                borderColor: "#fff",
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: "circle",
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage = ((context.raw / total) * 100).toFixed(1);
                    return (
                      context.label +
                      ": " +
                      context.raw +
                      " (" +
                      percentage +
                      "%)"
                    );
                  },
                },
              },
            },
            cutout: "55%",
          },
        });
      </script>
    </div>
  </body>
</html>
