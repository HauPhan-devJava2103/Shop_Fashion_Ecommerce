<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
  <head>
    <title>Đăng nhập</title>
  </head>
  <body>
    <main layout:fragment="content">
      <div class="container py-5" style="max-width: 480px">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h3 class="mb-3">Đăng nhập</h3>

            <!-- Success Messages -->
            <div th:if="${param.registered}" class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>Đăng ký thành công! Vui
              lòng đăng nhập.
            </div>
            <div th:if="${param.reset}" class="alert alert-success">
              <i class="bi bi-check-circle me-2"></i>Đặt lại mật khẩu thành
              công!
            </div>

            <!-- Error/Success containers for JS -->
            <div
              id="errorMsg"
              class="alert alert-danger"
              style="display: none"></div>
            <div
              id="successMsg"
              class="alert alert-success"
              style="display: none"></div>

            <form id="loginForm">
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  class="form-control"
                  type="email"
                  id="email"
                  name="email"
                  placeholder="your@email.com"
                  required />
              </div>

              <div class="mb-3">
                <label class="form-label">Mật khẩu</label>
                <input
                  class="form-control"
                  type="password"
                  id="password"
                  name="password"
                  placeholder="••••••"
                  required />
              </div>

              <div class="d-flex justify-content-end mb-3">
                <a
                  th:href="@{/forgot-password}"
                  class="text-decoration-none small text-primary fw-semibold">
                  Quên mật khẩu?
                </a>
              </div>

              <div class="form-check mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="rememberMe"
                  name="rememberMe" />
                <label class="form-check-label" for="rememberMe">
                  Ghi nhớ đăng nhập
                </label>
              </div>

              <button
                type="submit"
                class="btn btn-primary w-100"
                id="submitBtn">
                Đăng nhập
              </button>
            </form>

            <div class="mt-3 text-center">
              <span class="text-muted">Chưa có tài khoản?</span>
              <a th:href="@{/register}" class="text-primary fw-semibold"
                >Đăng ký</a
              >
            </div>
          </div>
        </div>
      </div>

      <script>
        document
          .getElementById("loginForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const rememberMe = document.getElementById("rememberMe").checked;
            const submitBtn = document.getElementById("submitBtn");
            const errorMsg = document.getElementById("errorMsg");
            const successMsg = document.getElementById("successMsg");

            // Reset messages
            errorMsg.style.display = "none";
            successMsg.style.display = "none";
            submitBtn.disabled = true;
            submitBtn.textContent = "Đang đăng nhập...";

            try {
              const response = await fetch("/api/auth/login", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ email, password, rememberMe }),
              });

              const data = await response.json();

              if (data.success) {
                // Save token to localStorage
                localStorage.setItem("jwt_token", data.data.token);
                localStorage.setItem("user_role", data.data.role);
                localStorage.setItem("user_email", data.data.email);
                localStorage.setItem("user_fullName", data.data.fullName);

                // Cookie for server-side authentication is set by the backend (HttpOnly)

                successMsg.textContent =
                  "Đăng nhập thành công! Đang chuyển hướng...";
                successMsg.style.display = "block";

                // Redirect based on role
                setTimeout(() => {
                  if (
                    data.data.role === "ADMIN" ||
                    data.data.role === "STAFF"
                  ) {
                    window.location.href = "/admin";
                  } else {
                    window.location.href = "/";
                  }
                }, 1000);
              } else {
                errorMsg.textContent = data.message;
                errorMsg.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.textContent = "Đăng nhập";
              }
            } catch (error) {
              errorMsg.textContent = "Có lỗi xảy ra. Vui lòng thử lại.";
              errorMsg.style.display = "block";
              submitBtn.disabled = false;
              submitBtn.textContent = "Đăng nhập";
            }
          });
      </script>
    </main>
  </body>
</html>
