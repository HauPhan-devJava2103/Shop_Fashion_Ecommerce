<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
  <head>
    <title>Đặt lại mật khẩu</title>
    <style>
      .otp-input {
        letter-spacing: 0.5rem;
        font-size: 1.2rem;
        text-align: center;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <main layout:fragment="content">
      <div class="container py-5" style="max-width: 480px">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h3 class="mb-3">Đặt lại mật khẩu</h3>
            <p class="text-muted">
              Mã OTP đã được gửi đến
              <strong th:text="${email}">email@example.com</strong>
            </p>

            <div
              th:if="${error}"
              class="alert alert-danger"
              th:text="${error}"></div>

            <form
              th:action="@{/reset-password}"
              th:object="${resetPassword}"
              method="post">
              <input type="hidden" name="email" th:value="${email}" />

              <div class="mb-3">
                <label class="form-label">Mã OTP (6 số)</label>
                <input
                  type="text"
                  name="otpCode"
                  class="form-control otp-input"
                  maxlength="6"
                  pattern="[0-9]{6}"
                  placeholder="______"
                  required
                  autofocus />
              </div>

              <div class="mb-3">
                <label class="form-label">Mật khẩu mới</label>
                <input
                  class="form-control"
                  type="password"
                  name="newPassword"
                  th:field="*{newPassword}"
                  placeholder="Ít nhất 6 ký tự"
                  required />
                <div
                  class="text-danger small mt-1"
                  th:if="${#fields.hasErrors('newPassword')}"
                  th:errors="*{newPassword}"></div>
              </div>

              <div class="mb-3">
                <label class="form-label">Xác nhận mật khẩu</label>
                <input
                  class="form-control"
                  type="password"
                  name="confirmPassword"
                  th:field="*{confirmPassword}"
                  placeholder="Nhập lại mật khẩu"
                  required />
              </div>

              <button type="submit" class="btn btn-success w-100 mb-3">
                Đặt lại mật khẩu
              </button>

              <div class="text-center mb-3">
                <span class="text-muted">Không nhận được mã?</span>
                <button
                  type="button"
                  class="btn btn-link p-0"
                  id="resendBtn"
                  onclick="resendResetOtp()">
                  Gửi lại OTP
                </button>
              </div>

              <div class="text-center">
                <a
                  th:href="@{/forgot-password}"
                  class="text-decoration-none text-muted">
                  ← Quay lại
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        const email = /*[[${email}]]*/ "";

        // Only allow numbers in OTP input
        document
          .querySelector('input[name="otpCode"]')
          .addEventListener("input", function (e) {
            this.value = this.value.replace(/[^0-9]/g, "");
          });

        async function resendResetOtp() {
          const btn = document.getElementById("resendBtn");
          btn.disabled = true;
          btn.textContent = "Đang gửi...";

          try {
            const response = await fetch("/resend-reset-otp", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ email: email }),
            });

            const data = await response.json();
            alert(data.message);
          } catch (error) {
            alert("Có lỗi xảy ra. Vui lòng thử lại.");
          }

          btn.disabled = false;
          btn.textContent = "Gửi lại OTP";
        }
      </script>
    </main>
  </body>
</html>
