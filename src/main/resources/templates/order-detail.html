<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
  <head>
    <title>Chi tiết đơn hàng</title>
    <style>
      /* Fix modal z-index issue */
      .modal {
        z-index: 1060 !important;
      }
      .modal-backdrop {
        z-index: 1050 !important;
      }
    </style>
  </head>
  <body>
    <main layout:fragment="content">
      <section class="shop_grid_area section-padding-80">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-9">
              <div class="mb-4">
                <h4 class="mb-1">Chi tiết đơn hàng</h4>
                <p class="text-muted mb-0" th:if="${order != null}">
                  Mã đơn:
                  <span class="fw-semibold" th:text="${order.id}">0</span>
                </p>
              </div>

              <div class="bg-white rounded p-4" style="border: 1px solid #eee">
                <div
                  th:if="${successMessage}"
                  class="alert alert-success"
                  th:text="${successMessage}">
                  Thành công
                </div>
                <div
                  th:if="${errorMessage}"
                  class="alert alert-danger"
                  th:text="${errorMessage}">
                  Lỗi
                </div>

                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="text-muted" style="font-size: 13px">
                      Trạng thái hiện tại
                    </div>
                    <div
                      class="fw-semibold"
                      style="font-size: 18px"
                      th:text="${order.orderStatus.displayName}">
                      Chờ xác nhận
                    </div>
                    <div
                      class="text-muted"
                      style="font-size: 13px"
                      th:text="'Ngày tạo: ' + ${order.createdAt}"></div>
                  </div>
                  <div class="text-end">
                    <div class="text-muted" style="font-size: 13px">
                      Tổng tiền
                    </div>
                    <div
                      class="fw-semibold"
                      style="font-size: 18px"
                      th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                      0đ
                    </div>
                    <div
                      class="text-muted"
                      style="font-size: 13px"
                      th:text="${order.paymentMethod.displayName}"></div>
                  </div>
                </div>

                <hr />

                <!-- Cancelled info -->
                <div
                  th:if="${order.orderStatus.name() == 'CANCELLED'}"
                  class="mb-4">
                  <h6 class="mb-2">Thông tin hủy đơn</h6>
                  <div
                    class="text-muted"
                    th:if="${order.cancelReason != null}"
                    th:text="'Lý do: ' + ${order.cancelReason.displayName}"></div>
                  <div
                    class="text-muted"
                    th:if="${order.cancelledAt != null}"
                    th:text="'Thời gian hủy: ' + ${order.cancelledAt}"></div>
                  <div
                    class="text-muted"
                    th:if="${order.cancelReasonNote != null && !order.cancelReasonNote.isEmpty()}"
                    th:text="'Ghi chú: ' + ${order.cancelReasonNote}"></div>
                </div>

                <!-- Cancel form (only when pending) -->
                <div
                  th:if="${order.orderStatus.name() == 'PENDING'}"
                  class="mb-4">
                  <h6 class="mb-2">Hủy đơn hàng</h6>
                  <form
                    th:action="@{'/orders/' + ${order.id} + '/cancel'}"
                    method="post"
                    class="row g-2 align-items-end">
                    <div class="col-12 col-md-5">
                      <label class="form-label" style="font-size: 13px"
                        >Lý do hủy</label
                      >
                      <select class="form-select" name="reason" required>
                        <option value="" selected disabled>
                          -- Chọn lý do --
                        </option>
                        <option
                          th:each="r : ${cancelReasons}"
                          th:value="${r.name()}"
                          th:text="${r.displayName}"></option>
                      </select>
                    </div>
                    <div class="col-12 col-md-5">
                      <label class="form-label" style="font-size: 13px"
                        >Ghi chú (tuỳ chọn)</label
                      >
                      <input
                        class="form-control"
                        type="text"
                        name="note"
                        maxlength="500"
                        placeholder="Nhập thêm chi tiết (nếu cần)" />
                    </div>
                    <div class="col-12 col-md-2">
                      <button
                        type="submit"
                        class="btn btn-outline-danger w-100"
                        onclick="return confirm('Bạn chắc chắn muốn hủy đơn hàng này?');">
                        Hủy đơn
                      </button>
                    </div>
                  </form>
                  <div class="text-muted mt-2" style="font-size: 12px">
                    Chỉ có thể hủy khi đơn đang ở trạng thái chờ xác nhận.
                  </div>
                </div>

                <div th:if="${order.orderAddress != null}">
                  <h6 class="mb-2">Thông tin giao hàng</h6>
                  <div
                    class="text-muted"
                    th:text="${order.orderAddress.recipientName}"></div>
                  <div
                    class="text-muted"
                    th:text="${order.orderAddress.phone}"></div>
                  <div
                    class="text-muted"
                    th:text="${order.orderAddress.addressLine}"></div>
                  <div
                    class="text-muted"
                    th:text="${(order.orderAddress.ward != null ? order.orderAddress.ward + ', ' : '') + (order.orderAddress.district != null ? order.orderAddress.district + ', ' : '') + (order.orderAddress.city != null ? order.orderAddress.city : '')}"></div>
                </div>

                <div
                  th:if="${order.orderItems != null and !order.orderItems.isEmpty()}"
                  class="mt-4">
                  <h6 class="mb-2">Sản phẩm</h6>
                  <div
                    th:each="oi, iterStat : ${order.orderItems}"
                    class="py-3"
                    style="border-bottom: 1px dashed #eee">
                    <div class="d-flex justify-content-between">
                      <div style="max-width: 60%">
                        <div
                          class="fw-semibold"
                          th:text="${oi.variant != null && oi.variant.product != null ? oi.variant.product.productName : ''}">
                          Product
                        </div>
                        <div
                          class="text-muted"
                          style="font-size: 13px"
                          th:text="${(oi.variant != null && oi.variant.color != null ? 'Màu: ' + oi.variant.color : '') + (oi.variant != null && oi.variant.size != null ? ' | Size: ' + oi.variant.size : '')}"></div>
                        <div
                          class="text-muted"
                          style="font-size: 13px"
                          th:text="'SL: ' + ${oi.quantity} + ' x ' + ${#numbers.formatDecimal(oi.unitPrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></div>
                      </div>
                      <div class="text-end">
                        <div
                          class="fw-semibold"
                          th:text="${#numbers.formatDecimal(oi.totalPrice, 0, 'COMMA', 0, 'POINT')} + 'đ'">
                          0đ
                        </div>
                        <!-- Review button for COMPLETED orders -->
                        <div
                          th:if="${order.orderStatus.name() == 'COMPLETED'}"
                          class="mt-2">
                          <!-- Already reviewed -->
                          <span
                            th:if="${oi.review != null}"
                            class="badge bg-success">
                            <i class="fa fa-check me-1"></i>Đã đánh giá
                          </span>
                          <!-- Not reviewed yet - show button to open modal -->
                          <button
                            th:unless="${oi.review != null}"
                            type="button"
                            class="btn btn-outline-warning btn-sm"
                            data-bs-toggle="modal"
                            th:data-bs-target="'#reviewModal' + ${oi.id}">
                            <i class="fa fa-star me-1"></i>Viết đánh giá
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Display existing review -->
                    <div
                      th:if="${oi.review != null}"
                      class="mt-2 p-2 rounded"
                      style="background: #f8f9fa">
                      <div class="d-flex align-items-center gap-1 mb-1">
                        <span
                          th:each="star : ${#numbers.sequence(1, 5)}"
                          th:class="${star <= oi.review.rating ? 'text-warning' : 'text-muted'}">
                          <i class="fa fa-star"></i>
                        </span>
                        <span
                          class="ms-2 text-muted"
                          style="font-size: 12px"
                          th:text="${oi.review.isApproved ? '(Đã duyệt)' : '(Chờ duyệt)'}"></span>
                      </div>
                      <p
                        th:if="${oi.review.comment != null and !oi.review.comment.isEmpty()}"
                        class="mb-1"
                        style="font-size: 14px"
                        th:text="${oi.review.comment}"></p>
                      <img
                        th:if="${oi.review.imageUrl != null}"
                        th:src="${oi.review.imageUrl}"
                        alt="Review image"
                        style="
                          max-width: 100px;
                          max-height: 100px;
                          object-fit: cover;
                          border-radius: 4px;
                        " />
                    </div>

                    <!-- Review Modal -->
                    <div
                      th:unless="${oi.review != null}"
                      class="modal fade"
                      th:id="'reviewModal' + ${oi.id}"
                      tabindex="-1"
                      aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <form
                            th:action="@{/reviews/submit}"
                            method="post"
                            enctype="multipart/form-data">
                            <input
                              type="hidden"
                              name="orderItemId"
                              th:value="${oi.id}" />
                            <input
                              type="hidden"
                              name="returnUrl"
                              th:value="${'/orders/' + order.id}" />
                            <div class="modal-header">
                              <h5 class="modal-title">Đánh giá sản phẩm</h5>
                              <button
                                type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                              <div class="mb-3 text-center">
                                <strong
                                  th:text="${oi.variant != null && oi.variant.product != null ? oi.variant.product.productName : ''}"></strong>
                              </div>

                              <!-- Star Rating -->
                              <div class="mb-3">
                                <label class="form-label"
                                  >Đánh giá của bạn
                                  <span class="text-danger">*</span></label
                                >
                                <div
                                  class="star-rating d-flex gap-2 justify-content-center"
                                  style="font-size: 24px">
                                  <input
                                    type="hidden"
                                    name="rating"
                                    th:id="'rating' + ${oi.id}"
                                    value="5"
                                    required />
                                  <span
                                    th:each="star : ${#numbers.sequence(1, 5)}"
                                    th:data-value="${star}"
                                    th:data-target="'rating' + ${oi.id}"
                                    class="star-btn text-warning"
                                    style="cursor: pointer"
                                    onclick="selectRating(this)">
                                    <i class="fa fa-star"></i>
                                  </span>
                                </div>
                              </div>

                              <!-- Comment -->
                              <div class="mb-3">
                                <label class="form-label"
                                  >Nhận xét của bạn</label
                                >
                                <textarea
                                  name="comment"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm..."></textarea>
                              </div>

                              <!-- Image upload -->
                              <div class="mb-3">
                                <label class="form-label"
                                  >Thêm hình ảnh (tuỳ chọn)</label
                                >
                                <input
                                  type="file"
                                  name="image"
                                  class="form-control"
                                  accept="image/*" />
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button
                                type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal">
                                Đóng
                              </button>
                              <button type="submit" class="btn essence-btn">
                                Gửi đánh giá
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <script>
                  function selectRating(el) {
                    const value = el.getAttribute("data-value");
                    const targetId = el.getAttribute("data-target");
                    document.getElementById(targetId).value = value;

                    // Update star display
                    const container = el.parentElement;
                    const stars = container.querySelectorAll(".star-btn");
                    stars.forEach((star, index) => {
                      if (index < value) {
                        star.classList.remove("text-muted");
                        star.classList.add("text-warning");
                      } else {
                        star.classList.remove("text-warning");
                        star.classList.add("text-muted");
                      }
                    });
                  }
                </script>

                <div class="mt-4 d-flex gap-2 flex-wrap">
                  <a th:href="@{/orders}" class="btn essence-btn"
                    >Quay lại danh sách</a
                  >
                  <a th:href="@{/shop}" class="btn essence-btn"
                    >Tiếp tục mua sắm</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </body>
</html>
