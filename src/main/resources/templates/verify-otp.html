<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/main}">
  <head>
    <title>Xác thực OTP</title>
    <style>
      .otp-input {
        letter-spacing: 1rem;
        font-size: 1.5rem;
        text-align: center;
        font-weight: bold;
      }
      .countdown {
        color: #6c757d;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <main layout:fragment="content">
      <div class="container py-5" style="max-width: 500px">
        <div class="card shadow-sm">
          <div class="card-body p-4 text-center">
            <div class="mb-4">
              <i
                class="bi bi-envelope-check"
                style="font-size: 3rem; color: #0d6efd"></i>
            </div>

            <h3 class="mb-3">Xác thực Email</h3>

            <p class="text-muted">
              Chúng tôi đã gửi mã OTP đến email:<br />
              <strong th:text="${email}">email@example.com</strong>
            </p>

            <div
              th:if="${error}"
              class="alert alert-danger"
              th:text="${error}"></div>

            <form th:action="@{/verify-otp}" method="post" class="mt-4">
              <input type="hidden" name="email" th:value="${email}" />

              <div class="mb-4">
                <label class="form-label">Nhập mã OTP (6 số)</label>
                <input
                  type="text"
                  name="otpCode"
                  class="form-control otp-input"
                  maxlength="6"
                  pattern="[0-9]{6}"
                  placeholder="______"
                  required
                  autofocus />
              </div>

              <button type="submit" class="btn btn-primary btn-lg w-100">
                Xác nhận
              </button>
            </form>

            <hr class="my-4" />

            <p class="countdown mb-2">
              Mã OTP có hiệu lực trong <span id="timer">5:00</span>
            </p>

            <p class="mb-0">
              Không nhận được mã?
              <button
                type="button"
                class="btn btn-link p-0"
                id="resendBtn"
                onclick="resendOtp()">
                Gửi lại OTP
              </button>
            </p>

            <div class="mt-3">
              <a th:href="@{/register}" class="text-muted">
                ← Quay lại đăng ký
              </a>
            </div>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        const email = [[${email}]];

        // Countdown timer
        let timeLeft = 300; // 5 minutes in seconds
        const timerDisplay = document.getElementById('timer');

        const countdown = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

          if (--timeLeft < 0) {
            clearInterval(countdown);
            timerDisplay.textContent = 'Hết hạn';
            timerDisplay.style.color = 'red';
          }
        }, 1000);

        // Resend OTP function
        function resendOtp() {
          const btn = document.getElementById('resendBtn');
          btn.disabled = true;
          btn.textContent = 'Đang gửi...';

          fetch('/resend-otp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ email: email })
          })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            if (data.success) {
              // Reset timer
              timeLeft = 300;
            }
            btn.disabled = false;
            btn.textContent = 'Gửi lại OTP';
          })
          .catch(error => {
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
            btn.disabled = false;
            btn.textContent = 'Gửi lại OTP';
          });
        }

        // Auto-submit when 6 digits entered
        document.querySelector('input[name="otpCode"]').addEventListener('input', function(e) {
          this.value = this.value.replace(/[^0-9]/g, '');
        });
      </script>
    </main>
  </body>
</html>
